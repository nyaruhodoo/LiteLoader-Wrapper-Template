"use strict";const b=require("node:process"),R=require("node:events"),W=require("node:util");class x{constructor(n,o,t={}){this.Wrapper=n,this.Session=o,this.config=t,this.wrapperEmitter=new R.EventEmitter,this.#e=new Map}#e;logFn({argArray:n,applyRet:o,key:t}){if(!this.config.log||typeof this.config.log!="boolean"&&!this.config.log.test(t))return;const r=this.config.logDepth,a={inspect(e){return W.inspect(e,{depth:r,colors:!0})},json(e){return JSON.stringify(e,null,2)}}[this.config.logType??"inspect"];if(console.log("-----------------------------------------------"),console.log(`${t} 被调用`),n.length&&console.log("参数: ",a(n)),o instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),o.then(e=>{console.log(`${t} 返回值: `),console.log(a(e))},e=>{console.log(`${t} 返回值: `),console.log(a(e))});else if(console.log("返回值: ",a(o)),typeof o=="object"&&o){const e=Object.getOwnPropertyNames(o);e.length&&console.log("返回值 keys: ",a(e)),console.log("原型 keys: ",a(Object.getOwnPropertyNames(Object.getPrototypeOf(o))))}}hookInstance({instance:n,rootKey:o}){return new Proxy(n,{get:(t,r,i)=>{const a=Reflect.get(n,r,i);if(typeof a!="function")return a;const e=`${o}/${r}`;return(...l)=>{if(this.config.eventBlacklist?.some(s=>typeof s=="string"?e===s:s.test(e)))return;if(e.endsWith("Listener"))if(r.startsWith("add")){const s=this.#e.get(e);l[0]=this.hookInstance({instance:l[0],rootKey:e}),s?s.add(l[0]):this.#e.set(e,new Set([l[0]]))}else{const s=this.#e.get(e.replace("/remove","/add"));s&&s.delete(l[0])}l=(()=>{if(this.config.eventInterceptors?.[e])return Array.isArray(this.config.eventInterceptors[e])?this.config.eventInterceptors[e].reduce((s,g)=>g(s),l):this.config.eventInterceptors?.[e]?.(l)})()??l;let p=n[r](...l);if(p=(()=>{if(this.config.eventInterceptors?.[`${e}:response`])return Array.isArray(this.config.eventInterceptors[`${e}:response`])?this.config.eventInterceptors[`${e}:response`].reduce((s,g)=>g(s),p):this.config.eventInterceptors?.[`${e}:response`]?.(p)})()??p,e.endsWith("Service")&&(p=this.hookInstance({instance:p,rootKey:e})),p instanceof Promise)p.then(s=>{const g={applyRet:s,params:l};this.wrapperEmitter.emit(e,g)},s=>{const g={applyRet:s,params:l};this.wrapperEmitter.emit(e,g)});else{const s={applyRet:p,params:l};this.wrapperEmitter.emit(e,s)}return this.logFn({argArray:l,applyRet:p,key:e}),p}}})}dispatchListener(n,o){const t=n.lastIndexOf("/"),r=n.slice(0,t),i=n.slice(t+1),a=this.#e.get(r);if(!a)throw new Error("监听器尚未绑定，请确认参数是否正确");return[...a].map(e=>{if(!e[i])throw new Error("未找到目标监听器");return e[i](...o)})}}const j={switchh:!1,select:"",input:""},C="https://raw.githubusercontent.com/adproqwq/LiteLoaderQQNT-Manifest-JsonSchema/main/manifest.schema.json",T=4,$="extension",M="liteloader-wrapper-template",_="liteloader-wrapper-template",D="LiteLoaderQQNT的插件模板",K="0.0.1",U=[{name:"Nyaruhodo",link:"https://github.com/nyaruhodoo"}],q=[],A=["win32","linux","darwin"],B={renderer:"./out/renderer/index.js",main:"./out/main/index.js",preload:"./out/preload/index.js"},v={$schema:C,manifest_version:T,type:$,name:M,slug:_,description:D,version:K,authors:U,dependencies:q,platform:A,injects:B};class E{static async getConfig(){const n=await LiteLoader.api.config.get(v.slug,j);return this.mergeConfig(n,j)}static async updateConfig(n){await LiteLoader.api.config.set(v.slug,n),this.log("Config已更新",JSON.stringify(n,null,2))}static mergeConfig(n,o){const t=structuredClone(o);for(const[r,i]of Object.entries(n))if(Object.hasOwn(t,r)&&Object.prototype.toString.call(i)===Object.prototype.toString.call(t[r])){if(Array.isArray(i)){t[r]=[...new Set([...i,...t[r]])];continue}if(typeof i=="object"&&i){t[r]=this.mergeConfig(i,t[r]);continue}t[r]=i}return t}static log(...n){console.log(`${v.slug}:`,...n)}}let S=!1;const F=(c,n)=>({log:c.log,logDepth:c.logDepth,logType:c.logType,eventBlacklist:Array.from(new Set([...c.eventBlacklist||[],...n.eventBlacklist||[]])),eventInterceptors:(()=>{const o={...c.eventInterceptors};for(const[t,r]of Object.entries(n.eventInterceptors||{}))o[t]?Array.isArray(o[t])?o[t].push(r):o[t]=[o[t],r]:o[t]=r;return o})()}),f=(globalThis.starWand||(Object.defineProperty(globalThis,"starWand",{value:new x,writable:!1,enumerable:!1}),S=!0,E.log("StarWand 实例已初始化")),globalThis.starWand),J=(c={})=>{const{promise:n,resolve:o}=Promise.withResolvers();return f.config=S?c:F(f.config,c),S&&(b.dlopen=new Proxy(b.dlopen,{apply(t,r,i){const[,a]=i,e=Reflect.apply(t,r,i);if(a.includes("wrapper.node")){const l=i[0].exports,I=new Proxy(l,{get(p,s,g){const h=Reflect.get(l,s,g);return typeof h!="function"?h:new Proxy(function(){},{get(k,d,m){const u=Reflect.get(h,d,m);return typeof u!="function"?u:new Proxy(u,{apply(O,P,L){const w=`${s}/${d}`,y=Reflect.apply(O,P,L);if(f?.logFn({argArray:L,applyRet:y,key:w}),typeof y!="object")return y;const N=f.hookInstance({instance:y,rootKey:w});return w==="NodeIQQNTWrapperSession/create"&&(f.Session=N),N}})},construct(k,d,m){const u=Reflect.construct(h,d,m);return f?.logFn({key:s,applyRet:u,argArray:d}),f.hookInstance({instance:u,rootKey:s})}})}});f.Wrapper=i[0].exports=I}return e}})),f.wrapperEmitter.once("NodeIQQNTWrapperSession/create/getMsgService",()=>{o(f)}),n};var Q=(c=>(c.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",c.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",c.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",c.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",c.fetchUnitedCommendConfig="NodeIQQNTWrapperSession/create/getUnitedConfigService/fetchUnitedCommendConfig",c))(Q||{});(async()=>await J({log:!1,logDepth:null,eventBlacklist:[Q.sendLog,/tianshu/i]}))();
