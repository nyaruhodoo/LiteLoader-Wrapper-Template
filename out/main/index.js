"use strict";const L=require("node:events"),P=require("node:process"),W=require("node:util");class M{constructor(i,n,l={}){this.Wrapper=i,this.Session=n,this.config=l,this.wrapperEmitter=new L.EventEmitter}logFn({argArray:i,applyRet:n,key:l}){if(!this.config.log||typeof this.config.log!="boolean"&&!this.config.log.test(l))return;const p=this.config.logDepth,s={inspect(e){return W.inspect(e,{depth:p,colors:!0})},json(e){return JSON.stringify(e,null,2)}}[this.config.logType??"inspect"];if(console.log("-----------------------------------------------"),console.log(`${l} 被调用`),i.length&&console.log("参数: ",s(i)),n instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),n.then(e=>{console.log(`${l} 返回值: `),console.log(s(e))},e=>{console.log(`${l} 返回值: `),console.log(s(e))});else if(console.log("返回值: ",s(n)),typeof n=="object"&&n){const e=Object.getOwnPropertyNames(n);e.length&&console.log("返回值 keys: ",s(e)),console.log("原型 keys: ",s(Object.getOwnPropertyNames(Object.getPrototypeOf(n))))}}hookInstance({instance:i,rootKey:n}){return new Proxy(i,{get:(l,p,f)=>{const s=Reflect.get(i,p,f);if(typeof s!="function")return s;const e=`${n}/${p}`;return(...t)=>{if(this.config.eventBlacklist?.some(o=>typeof o=="string"?e===o:o.test(e)))return;e.endsWith("Listener")&&(t[0]=this.hookInstance({instance:t[0],rootKey:e})),t=this.config.eventInterceptors?.[e]?.(t)??t;let r=i[p](...t);if(r=this.config.eventInterceptors?.[`${e}:response`]?.({applyRet:r,params:t})??r,e.endsWith("Service")&&(r=this.hookInstance({instance:r,rootKey:e})),r instanceof Promise)r.then(o=>{const h={applyRet:o,params:t};this.wrapperEmitter.emit(e,h)},o=>{const h={applyRet:o,params:t};this.wrapperEmitter.emit(e,h)});else{const o={applyRet:r,params:t};this.wrapperEmitter.emit(e,o)}return this.logFn({argArray:t,applyRet:r,key:e}),r}}})}}const g=new M,$=(c={})=>{const{promise:i,resolve:n}=Promise.withResolvers();return g.config=c,P.dlopen=new Proxy(P.dlopen,{apply(l,p,f){const[,s]=f,e=Reflect.apply(l,p,f);if(s.includes("wrapper.node")){const t=f[0].exports,v=new Proxy(t,{get(r,o,h){const u=Reflect.get(t,o,h);return typeof u!="function"?u:new Proxy(function(){},{get(I,d,m){const a=Reflect.get(u,d,m);return typeof a!="function"?a:new Proxy(a,{apply(Q,k,w){const S=`${o}/${d}`,y=Reflect.apply(Q,k,w);if(g?.logFn({argArray:w,applyRet:y,key:S}),typeof y!="object")return y;const N=g.hookInstance({instance:y,rootKey:S});return S==="NodeIQQNTWrapperSession/create"&&(g.Session=N),N}})},construct(I,d,m){const a=Reflect.construct(u,d,m);return g?.logFn({key:o,applyRet:a,argArray:d}),g.hookInstance({instance:a,rootKey:o})}})}});g.Wrapper=f[0].exports=v}return e}}),g.wrapperEmitter.once("NodeIQQNTWrapperSession/create/getMsgService",()=>{n(g)}),i};var R=(c=>(c.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",c.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",c.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",c.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",c.fetchUnitedCommendConfig="NodeIQQNTWrapperSession/create/getUnitedConfigService/fetchUnitedCommendConfig",c))(R||{});(async()=>await $({log:!1,logDepth:null,eventBlacklist:[R.sendLog,/tianshu/i]}))();
